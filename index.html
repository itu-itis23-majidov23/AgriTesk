<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AgriTesk Sistemi - Tarım İzleme Platformu</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font:14px/1.4 "Inter",Arial,Helvetica,sans-serif;color:#444;background:#f4f6fa;overflow:hidden}
:root{
  --blue:#4A6FFF;--blue-light:#5A7FFF;--green:#28A745;--yellow:#FFC107;--red:#DC3545;
  --card-bg:#FAFAFA;--muted:#777;--border:#E5E5E5;--radius:6px;
}
header{padding:8px 16px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center}
header h1{font-size:20px;font-weight:700}
header span{margin-left:auto;font-size:13px;color:var(--muted)}
main{height:100%;display:flex;flex-direction:column;gap:10px;padding:10px;min-height:0}
.topSplit{flex:1 0 auto;display:flex;gap:10px;min-height:0}
#leftCol{flex:1;display:flex;flex-direction:column;gap:10px;min-width:300px}
.metric-grid{display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:160px;gap:10px;min-height:0}
.metric{position:relative;border:2px solid var(--blue);border-radius:8px;background:#fff}
.metric header{position:absolute;inset:0 0 auto 0;height:35px;background:var(--blue);color:#fff;font-weight:600;
               display:flex;justify-content:center;align-items:center;border-top-left-radius:6px;border-top-right-radius:6px}
.metric .val{position:absolute;inset:35px 0 0 0;display:flex;justify-content:center;align-items:center;
            font-size:36px;font-weight:700;color:var(--blue)}
.metric[data-type="ALT"]{--blue:#2E8B57}.metric[data-type="BAT"]{--blue:#CD853F}
#oriCanvas{width:100%;height:100%;background:#f0f8ff;border-radius:8px;border:2px solid #4682B4}
#rightCol{flex:3;display:flex;flex-direction:column;gap:10px;min-height:0;overflow:hidden}
.top-panels{height:24vh;display:flex;gap:8px;flex-shrink:0}
.panel{flex:1;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:8px;
       display:flex;flex-direction:column;padding:10px;overflow:hidden;
       box-shadow:0 1px 3px rgba(0,0,0,0.08);border:1px solid rgba(226,232,240,0.8)}
.panel h2{font-size:15px;font-weight:700;color:#26348B;margin-bottom:6px}
.sep{height:1px;background:var(--border);margin:6px 0}
.mid-panels{height:12vh;display:flex;gap:8px;flex-shrink:0}
.mid-panels .sub{flex:1;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:8px;padding:8px;display:flex;flex-direction:column;font-size:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.06);border:1px solid rgba(226,232,240,0.6)}
.mid-panels .sub h3{font-size:14px;font-weight:700;text-align:center;margin-bottom:4px}
.progress{width:100%;height:14px;border:1px solid #888;border-radius:6px;overflow:hidden}
.progress span{display:block;height:100%;background:#4CAF50;text-align:center;font-size:11px;color:#fff}
.bottom{height:56vh;display:flex;gap:8px;flex-shrink:0}
#graphs{flex:2;display:grid;grid-template-columns:repeat(3,1fr);grid-auto-rows:1fr;gap:8px;min-height:0;max-height:100%}
.chart-box{background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border:1px solid rgba(148,163,184,0.3);border-radius:8px;padding:4px;display:flex;flex-direction:column;min-height:0;max-height:100%;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
.chart-box canvas{flex:1 !important;min-height:0;max-height:100%}
#chatbot{flex:1;display:flex;flex-direction:column;background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border:1px solid rgba(148,163,184,0.3);border-radius:8px;min-height:0;max-height:100%;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
#chatbot header{font-size:14px;font-weight:700;text-align:center;background:linear-gradient(135deg, #4A6FFF 0%, #5A7FFF 100%);padding:6px;
             border-top-left-radius:8px;border-top-right-radius:8px;flex-shrink:0;color:#fff}
#chatArea{flex:1;overflow-y:auto;background:#fff;font-family:Inter,Arial,sans-serif;font-size:12px;padding:8px;max-height:calc(100% - 80px);display:flex;flex-direction:column;gap:8px}
.chat-input{padding:8px;display:flex;align-items:center;gap:6px;font-size:12px;flex-shrink:0;border-top:1px solid #ddd;background:#f8fafc}
.chat-input input{flex:1;padding:6px 10px;border:1px solid #ddd;border-radius:4px;font-size:12px}
.chat-input button{background:#4A6FFF;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px}
.chat-input button:hover{background:#5A7FFF}
.chat-input button:disabled{background:#ccc;cursor:not-allowed}
.chat-message{display:flex;flex-direction:column;margin-bottom:8px}
.chat-message.user{align-items:flex-end}
.chat-message.assistant{align-items:flex-start}
.message-bubble{max-width:80%;padding:8px 12px;border-radius:12px;font-size:11px;line-height:1.4;word-wrap:break-word}
.message-bubble.user{background:#4A6FFF;color:#fff;border-bottom-right-radius:4px}
.message-bubble.assistant{background:#e5e7eb;color:#374151;border-bottom-left-radius:4px}
.message-bubble.auto-notification{background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:#fff;border-bottom-left-radius:4px;border-left:3px solid #047857;box-shadow:0 2px 4px rgba(16,185,129,0.2)}
.chat-message.auto-notification .message-time{color:#059669;font-weight:600}
.message-time{font-size:9px;color:#6b7280;margin-top:2px;padding:0 4px}
.typing-indicator{display:flex;align-items:center;gap:4px;padding:8px 12px;background:#e5e7eb;border-radius:12px;border-bottom-left-radius:4px;max-width:80px}
.typing-dot{width:6px;height:6px;background:#6b7280;border-radius:50%;animation:typing 1.4s infinite}
.typing-dot:nth-child(2){animation-delay:0.2s}
.typing-dot:nth-child(3){animation-delay:0.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
@keyframes slideInLeft{0%{transform:translateX(-100%);opacity:0}100%{transform:translateX(0);opacity:1}}
@keyframes slideInRight{0%{transform:translateX(100%);opacity:0}100%{transform:translateX(0);opacity:1}}

/* Responsive Design for Different Screen Sizes */
@media screen and (max-width: 1200px) {
  .topSplit{flex-direction:column}
  #leftCol{min-width:auto;max-width:100%}
  .metric-grid{grid-template-columns:repeat(4,1fr);grid-auto-rows:120px}
  .metric .val{font-size:28px}
  .bottom{height:auto;min-height:50vh}
  #graphs{grid-template-columns:repeat(2,1fr)}
}

@media screen and (max-width: 768px) {
  html,body{font-size:12px}
  header{padding:6px 12px}
  header h1{font-size:18px}
  main{padding:8px;gap:8px}
  .metric-grid{grid-template-columns:repeat(2,1fr);grid-auto-rows:100px;gap:8px}
  .metric .val{font-size:24px}
  .metric header{height:28px;font-size:11px}
  .top-panels{height:auto;flex-direction:column}
  .panel{padding:8px}
  .panel h2{font-size:13px}
  .mid-panels{height:auto;flex-direction:column}
  .bottom{flex-direction:column;height:auto}
  #graphs{grid-template-columns:1fr;grid-auto-rows:200px}
  .chart-box{min-height:180px}
  #chatbot{min-height:300px}
  .device-control{padding:4px 8px}
  .device-info label{font-size:12px}
  .toggle-switch .slider{width:36px;height:20px}
  .toggle-switch .slider:before{width:16px;height:16px;top:2px;left:2px}
  .toggle-switch input:checked + .slider:before{transform:translateX(16px)}
}

@media screen and (max-width: 480px) {
  html,body{font-size:11px}
  header h1{font-size:16px}
  main{padding:6px;gap:6px}
  .metric-grid{grid-template-columns:1fr 1fr;grid-auto-rows:80px;gap:6px}
  .metric .val{font-size:20px}
  .metric header{height:24px;font-size:10px}
  .panel{padding:6px}
  .panel h2{font-size:12px}
  .top-panels .panel{min-height:120px}
  .mid-panels .sub{padding:6px}
  .chart-box{min-height:150px}
  #chatbot{min-height:250px}
  .chat-input{padding:6px}
  .chat-input input{padding:4px 8px;font-size:11px}
  .chat-input button{padding:4px 8px;font-size:11px}
  .message-bubble{font-size:10px;padding:6px 10px}
  .device-control{flex-direction:column;align-items:flex-start;gap:6px}
  .toggle-switch{align-self:flex-end}
}

/* Landscape orientation adjustments */
@media screen and (max-height: 600px) and (orientation: landscape) {
  .topSplit{flex-direction:row}
  #leftCol{flex:1;min-width:250px}
  .metric-grid{grid-template-columns:repeat(2,1fr);grid-auto-rows:80px}
  .metric .val{font-size:18px}
  .bottom{height:60vh}
  #graphs{grid-template-columns:repeat(3,1fr)}
}

.panel label{font-size:11px;color:var(--muted)}
.value{font-weight:600}
#mission .phase{font-weight:700;background:#E8E8E8;padding:6px;border-radius:4px;text-align:center;margin-bottom:6px}
.time-row{display:flex;gap:20px;font-size:12px;margin-bottom:6px}
.telemetry-grid{display:grid;grid-template-columns:auto auto;row-gap:6px}
.telemetry-grid div{display:flex;justify-content:space-between;align-items:center;font-size:12px}
#mission .event{font-size:12px;margin-top:auto}
.status-item{display:flex;align-items:center;justify-content:space-between;font-size:12px;margin-bottom:6px}
.status-dot{font-size:16px;margin-right:8px}
#command .cmd-row{display:flex;align-items:center;margin-bottom:8px;font-size:12px}
#command select,#command input{flex:1;padding:2px 5px;border:1px solid #DDD;border-radius:3px;font-size:12px}
#command button{margin-left:6px;background:var(--blue);border:none;color:#fff;padding:4px 10px;
                border-radius:3px;font-size:12px;cursor:pointer}
#command button:hover{background:var(--blue-light)}
#command #abort{background:#FF3B30;font-weight:700}
#command #abort:hover{background:#FF4B40}
.controls-section{flex-shrink:0;margin-bottom:8px}
.command-history{flex:1;display:flex;flex-direction:column;min-height:0}
.history-header{font-size:12px;font-weight:600;color:#6b7280;margin-bottom:6px;flex-shrink:0}
#command ul{flex:1;height:50px;overflow:auto;font-size:9px;border:1px solid rgba(203,213,225,0.5);border-radius:4px;padding:3px;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);margin:0;min-height:50px;max-height:50px;box-shadow:inset 0 1px 2px rgba(0,0,0,0.05)}
#chatArea::-webkit-scrollbar,#command ul::-webkit-scrollbar{width:6px}
#chatArea::-webkit-scrollbar-thumb,#command ul::-webkit-scrollbar-thumb{background:#bbb;border-radius:6px}
.device-control{
  display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;
  padding:6px 10px;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:6px;border:1px solid rgba(226,232,240,0.6);
  transition:all 0.2s ease;box-shadow:0 1px 2px rgba(0,0,0,0.04);
}
.device-control:hover{
  border-color:#d1d5db;box-shadow:0 1px 3px rgba(0,0,0,0.1);
}
.device-info{display:flex;align-items:center;gap:12px}
.device-control > .device-info > label{
  font-size:14px;font-weight:600;color:#374151;margin:0;
  display:flex;align-items:center;gap:6px;
}
.device-status{
  font-size:11px;font-weight:500;padding:2px 6px;border-radius:4px;
  transition:all 0.2s ease;
}
.device-status.off{background:#fef2f2;color:#dc2626;}
.device-status.on{background:#f0fdf4;color:#16a34a;}
.toggle-switch{position:relative;display:inline-block}
.toggle-switch input[type="checkbox"]{display:none}
.slider{
  position:relative;display:block;width:44px;height:24px;
  background:#e5e7eb;border-radius:12px;cursor:pointer;
  transition:background-color 0.2s ease;
}
.slider:before{
  content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;
  background:#fff;border-radius:50%;transition:transform 0.2s ease;
  box-shadow:0 1px 3px rgba(0,0,0,0.1);
}
.toggle-switch input:checked + .slider{
  background:#10b981;
}
.toggle-switch input:checked + .slider:before{
  transform:translateX(20px);
}
.slider:hover{
  box-shadow:0 0 0 3px rgba(16,185,129,0.1);
}
.slider-text{display:none}
.fish-comfort-container{display:flex;flex-direction:column;gap:6px;margin-top:4px;flex:1}
.fish-selector-modern{position:relative}
.fish-selector-modern select{
  width:100%;padding:6px 10px;border:1px solid rgba(148,163,184,0.3);
  border-radius:6px;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  font-size:10px;color:#374151;cursor:pointer;transition:all 0.2s ease;
  box-shadow:0 1px 2px rgba(0,0,0,0.05);
}
.fish-selector-modern select:hover{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
.fish-selector-modern select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
.fish-status-card{
  background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
  border-radius:6px;padding:6px;border:1px solid rgba(148,163,184,0.2);
  box-shadow:inset 0 1px 2px rgba(0,0,0,0.05);flex:1;display:flex;flex-direction:column;
}
.temp-display{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.temp-label{font-size:9px;color:#64748b;font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
.temp-value{font-size:12px;color:#1e293b;font-weight:700}
.status-display{display:flex;align-items:center;gap:6px}
.status-icon{font-size:14px}
.status-text{font-size:11px;font-weight:600}
.status-text.excellent{color:#16a34a}.status-icon.excellent::before{content:'✅'}
.status-text.good{color:#65a30d}.status-icon.good::before{content:'✅'}
.status-text.fair{color:#ca8a04}.status-icon.fair::before{content:'⚠️'}
.status-text.poor{color:#ea580c}.status-icon.poor::before{content:'⚠️'}
.status-text.critical{color:#dc2626}.status-icon.critical::before{content:'❌'}
</style>
</head>
<body>
<div id="app">
  <header><h1>AgriTesk Sistemi</h1><span id="clock"></span></header>
  <main>
    <div class="topSplit">
      <section id="leftCol">
        <div class="metric-grid">
          <div class="metric" data-type="WEATHER_TEMP"><header>HAVA SICAKLIĞI</header><span class="val" id="weatherTemp">--</span></div>
          <div class="metric" data-type="WATER_TEMP"><header>SU SICAKLIĞI</header><span class="val" id="waterTemp">--</span></div>
          <div class="metric" data-type="WEATHER_HUM"><header>HAVA NEM</header><span class="val" id="weatherHum">--</span></div>
          <div class="metric" data-type="SOIL_MOIST"><header>TOPRAK NEM</header><span class="val" id="soilMoist">--</span></div>
        </div>
      </section>
      <section id="rightCol">
        <div class="top-panels">
          <div class="panel" id="mission">
            <h2>🚀 GÖREV DURUMU</h2><div class="sep"></div>
            <div style="display:flex;flex-direction:column;align-items:center;gap:12px;">
              <div id="waterTank" style="width:60px;height:120px;position:relative;background:#e0e7ef;border-radius:16px;border:2px solid #4A6FFF;overflow:hidden;box-shadow:0 2px 8px #0001;">
                <div id="waterFill" style="position:absolute;bottom:0;left:0;width:100%;height:50%;background:linear-gradient(to top,#4A90E2 80%,#b3d8fd);transition:height 0.5s;"></div>
                <span id="waterIcon" style="position:absolute;top:8px;left:50%;transform:translateX(-50%);font-size:28px;color:#4A90E2;">💧</span>
              </div>
              <div style="font-size:18px;font-weight:600;letter-spacing:1px;">
                Su Seviyesi: <span id="waterLevelText">--</span>
              </div>
            </div>
          </div>
          <div class="panel" id="system">
            <h2>📋 ÖNERİLER & BİLDİRİMLER</h2><div class="sep"></div>
            <div id="recommendations" style="font-size:12px;line-height:1.4;max-height:200px;overflow-y:auto;">
              <div class="rec-item">• Sistem normal çalışıyor</div>
            </div>
          </div>
          <div class="panel" id="command" style="flex:1.2;display:flex;flex-direction:column;">
            <h2>🎮 KOMUT MERKEZİ</h2><div class="sep"></div>
            <div class="controls-section">
              <div class="device-control">
                <div class="device-info">
                  <label>💧 SU POMPASI</label>
                  <span class="device-status off" id="pumpStatus">Kapalı</span>
                </div>
                <div class="toggle-switch">
                  <input type="checkbox" id="pumpSwitch" onchange="togglePump(this)">
                  <label for="pumpSwitch" class="slider">
                    <span class="slider-text off">KAPAT</span>
                    <span class="slider-text on">AÇ</span>
                  </label>
                </div>
              </div>
              <div class="device-control">
                <div class="device-info">
                  <label>🌀 FAN</label>
                  <span class="device-status off" id="fanStatus">Kapalı</span>
                </div>
                <div class="toggle-switch">
                  <input type="checkbox" id="fanSwitch" onchange="toggleFan(this)">
                  <label for="fanSwitch" class="slider">
                    <span class="slider-text off">KAPAT</span>
                    <span class="slider-text on">AÇ</span>
                  </label>
                </div>
              </div>
            </div>
            <div class="command-history">
              <div class="history-header">Son Komutlar</div>
              <ul id="cmdHist"></ul>
            </div>
          </div>
        </div>
        <div class="mid-panels">
          <div class="sub" id="fishComfort">
            <h3>🐟 BALIK KONFOR ENDEKSİ</h3>
            <div class="fish-comfort-container">
              <div class="fish-selector-modern">
                <select id="fishSpecies" onchange="changeFishSpecies()">
                  <option value="tilapia">🐟 Tilapia (22-30°C)</option>
                  <option value="catfish">🐱 Catfish (22-28°C)</option>
                  <option value="carp">🐟 Carp (20-28°C)</option>
                  <option value="tench">🐟 Tench (18-25°C)</option>
                  <option value="trout">🐟 Rainbow Trout (12-20°C)</option>
                  <option value="bluegill">🐟 Bluegill (20-28°C)</option>
                  <option value="perch">🐟 Perch (15-25°C)</option>
                  <option value="bream">🐟 Bream (18-25°C)</option>
                </select>
              </div>
              <div class="fish-status-card">
                <div class="temp-display">
                  <span class="temp-label">Su Sıcaklığı</span>
                  <span class="temp-value"><span id="fishWaterTemp">--</span>°C</span>
                </div>
                <div class="status-display">
                  <span class="status-icon" id="fishStatusIcon">🔄</span>
                  <span class="status-text" id="fishStatus">--</span>
                </div>
              </div>
            </div>
          </div>
          <div class="sub">
            <h3>VERİ KAYDI</h3>
            <div style="margin-bottom:6px">Dosya: <code>data_log.csv</code></div>
            <button style="align-self:flex-start" onclick="recToggle()" id="recBtn">Kaydı Başlat</button>
          </div>
        </div>
      </section>
    </div>
    <div class="bottom">
      <div id="graphs">
        <div class="chart-box"><canvas id="weatherTempChart"></canvas></div>
        <div class="chart-box"><canvas id="waterTempChart"></canvas></div>
        <div class="chart-box"><canvas id="tempRatioChart"></canvas></div>
        <div class="chart-box"><canvas id="weatherHumChart"></canvas></div>
        <div class="chart-box"><canvas id="soilMoistChart"></canvas></div>
        <div class="chart-box"><canvas id="humRatioChart"></canvas></div>
      </div>
      <div id="chatbot">
        <header>🤖 TARIM UZMANI ASISTAN</header>
        <div id="chatArea"></div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Tarımsal sorularınızı sorun..." onkeypress="handleChatKeyPress(event)">
          <button onclick="sendMessage()" id="sendBtn">Gönder</button>
        </div>
      </div>
    </div>
  </main>
</div>
<script>

let roll = 0, pitch = 0, yaw = 0;
const alpha = 0.98;
let lastT = performance.now();

function updateIMU(accX,accY,accZ, gyrX,gyrY,gyrZ) {
  const now = performance.now(), dt = (now - lastT)/1000; // s
  lastT = now;
  const rollAcc  =  Math.atan2(accY, accZ);
  const pitchAcc = -Math.atan2(accX, Math.hypot(accY, accZ));
  roll  += gyrX * dt;
  pitch += gyrY * dt;
  yaw   += gyrZ * dt;
  roll  = alpha * roll  + (1-alpha) * rollAcc;
  pitch = alpha * pitch + (1-alpha) * pitchAcc;
  return {
    rollDeg  : roll  * 180/Math.PI,
    pitchDeg : pitch * 180/Math.PI,
    yawDeg   : yaw   * 180/Math.PI
  };
}

let file_text = ''

// Real-time data object - will be updated via WebSocket
let data = {
  "weatherTemp": 25.3,
  "waterTemp": 18.7,
  "weatherHum": 62.1,
  "soilMoist": 45.8,
  "waterLevel": 1,
  "fanState": 0,
  "pumpState": 0,
  "strength": 85,
  "total": 150,
  "lost": 3,
  "acc": [0.1, 0.2, 9.8],
  "gyro": [0.01, -0.02, 0.005]
}

// WebSocket connection
let socket = null;
let isConnected = false;

// WebSocket connection functions
function connectWebSocket() {
  if (socket && socket.readyState === WebSocket.OPEN) {
    return; // Already connected
  }
  
  // Use current host for WebSocket connection (works from any device)
  const wsHost = window.location.hostname;
  socket = new WebSocket(`ws://${wsHost}:8001/`);
  
  socket.onopen = function(event) {
    isConnected = true;
    console.log('WebSocket connected');
    console.log('WebSocket bağlantısı kuruldu');
    
    // Add welcome notification
    setTimeout(() => {
      console.log('🌱 Adding welcome notification...');
      addNotification('🌱 AgriTesk sistemi bağlandı - Otomatik kontroller aktif!');
      
      // Also add a test notification after 3 seconds
      setTimeout(() => {
        console.log('🔬 Adding test notification...');
        addNotification('🧪 Test: Bildirim sistemi çalışıyor!');
      }, 3000);
    }, 1000);
  };
  
  socket.onmessage = function(event) {
    try {
      const receivedData = JSON.parse(event.data);
      console.log('Received data:', receivedData);
      
      // Handle automatic control notifications
      if (receivedData.type === 'auto_notification') {
        console.log('🚨 RECEIVED AUTO NOTIFICATION:', receivedData.message);
        console.log('📦 Full notification data:', receivedData);
        addNotification(receivedData.message);
        return;
      }
      
      // Update data object with received sensor data
      if (receivedData.weatherTemp !== undefined) data.weatherTemp = receivedData.weatherTemp;
      if (receivedData.waterTemp !== undefined) data.waterTemp = receivedData.waterTemp;
      if (receivedData.weatherHum !== undefined) data.weatherHum = receivedData.weatherHum;
      if (receivedData.soilMoist !== undefined) data.soilMoist = receivedData.soilMoist;
      if (receivedData.water_level !== undefined) data.waterLevel = receivedData.water_level;
      if (receivedData.fanState !== undefined) {
        data.fanState = receivedData.fanState;
        // Update fan UI toggle
        updateDeviceUI('fan', receivedData.fanState);
      }
      if (receivedData.pumpState !== undefined) {
        data.pumpState = receivedData.pumpState;
        // Update pump UI toggle
        updateDeviceUI('pump', receivedData.pumpState);
      }
      if (receivedData.strength !== undefined) data.strength = receivedData.strength;
      if (receivedData.total !== undefined) data.total = receivedData.total;
      if (receivedData.lost !== undefined) data.lost = receivedData.lost;
      
      // Update derived values
      data.temperature = data.weatherTemp;
      data.humidity = data.weatherHum;
      
      console.log('Updated data:', data);
    } catch (e) {
      console.error('Error parsing WebSocket data:', e);
    }
  };
  
  socket.onclose = function(event) {
    isConnected = false;
    console.log('WebSocket disconnected');
    console.log('WebSocket bağlantısı kesildi');
    
    // Try to reconnect after 3 seconds
    setTimeout(connectWebSocket, 3000);
  };
  
  socket.onerror = function(error) {
    console.error('WebSocket error:', error);
    console.log('WebSocket hatası');
  };
}

// Update data with logical formulas (fallback when no real data)
function updateData() {
  // Only use dummy data if not connected to WebSocket
  if (!isConnected) {
    const time = Date.now() / 1000; // seconds since epoch
    
    // Temperature variations (day/night cycle simulation)
    data.weatherTemp = 25 + 10 * Math.sin(time * 0.01) + Math.random() * 2 - 1;
    data.waterTemp = 18 + 6 * Math.sin(time * 0.008) + Math.random() * 1.5 - 0.75;
    data.temperature = data.weatherTemp; // Same as weather temp
    
    // Humidity (inverse relationship with temperature)
    data.weatherHum = 70 - (data.weatherTemp - 25) * 1.5 + Math.random() * 5 - 2.5;
    data.soilMoist = 45 + 15 * Math.sin(time * 0.005) + Math.random() * 3 - 1.5;
    data.humidity = data.weatherHum; // Same as weather humidity
    
    // Altitude and velocity (simulate flight)
    data.altitude = 200 + 150 * Math.sin(time * 0.02) + Math.random() * 10 - 5;
    data.velocity = Math.cos(time * 0.02) * 5 + Math.random() * 1 - 0.5;
    
    // Battery drain over time
    data.battery_voltage = Math.max(3.3, 4.2 - (time * 0.0001));
    
    // Environmental
    data.pressure = 1015 + 5 * Math.sin(time * 0.003) + Math.random() * 2 - 1;
    data.light = 400 + 300 * Math.sin(time * 0.015) + Math.random() * 50 - 25;
    
    // Communication
    data.strength = 80 + 15 * Math.sin(time * 0.007) + Math.random() * 5 - 2.5;
    data.total += 1;
    if (Math.random() < 0.02) data.lost += 1;
    
    // Water level (occasionally low)
    data.waterLevel = Math.random() > 0.95 ? 0 : 1;
    
    // IMU data
    data.acc = [
      Math.random() * 2 - 1,
      Math.random() * 2 - 1,
      9.8 + Math.random() * 0.5 - 0.25
    ];
    data.gyro = [
      Math.random() * 0.2 - 0.1,
      Math.random() * 0.2 - 0.1,
      Math.random() * 0.1 - 0.05
    ];
    
    // Keep values in realistic ranges
    data.weatherTemp = Math.max(10, Math.min(45, data.weatherTemp));
    data.waterTemp = Math.max(5, Math.min(35, data.waterTemp));
    data.weatherHum = Math.max(20, Math.min(95, data.weatherHum));
    data.soilMoist = Math.max(15, Math.min(85, data.soilMoist));
    data.strength = Math.max(0, Math.min(100, data.strength));
  }
}


(function init () {
  const $ = id => document.getElementById(id);
  // Only define elements that actually exist in the HTML
  const recBtn = $('recBtn');
  const chatArea = $('chatArea'), chatInput = $('chatInput'), sendBtn = $('sendBtn');
  const clock = $('clock');
  const cmdHist = $('cmdHist');
  const recommendations = $('recommendations');
  
  // Fish comfort elements
  const fishWaterTemp = $('fishWaterTemp'), fishStatus = $('fishStatus');
  const fishStatusIcon = $('fishStatusIcon'), fishSpecies = $('fishSpecies');
  
  // Add the missing oriCanvas element - it doesn't exist in HTML, so create a placeholder
  const oriCanvas = document.createElement('div');
  
  // Fish species data with optimal temperature ranges
  const fishData = {
    tilapia: { min: 22, max: 30, name: 'Tilapia' },
    catfish: { min: 22, max: 28, name: 'Catfish' },
    carp: { min: 20, max: 28, name: 'Carp' },
    tench: { min: 18, max: 25, name: 'Tench' },
    trout: { min: 12, max: 20, name: 'Rainbow Trout' },
    bluegill: { min: 20, max: 28, name: 'Bluegill' },
    perch: { min: 15, max: 25, name: 'Perch' },
    bream: { min: 18, max: 25, name: 'Bream' }
  };
  
  function getFishStatus(waterTemp, selectedSpecies) {
    const fish = fishData[selectedSpecies];
    if (!fish) return { text: '--', class: '' };
    
    if (waterTemp >= fish.min && waterTemp <= fish.max) {
      return { text: 'Mükemmel', class: 'excellent' };
    } else if (waterTemp >= fish.min - 3 && waterTemp <= fish.max + 3) {
      return { text: 'İyi', class: 'good' };
    } else if (waterTemp >= fish.min - 5 && waterTemp <= fish.max + 5) {
      return { text: 'Orta', class: 'fair' };
    } else if (waterTemp >= fish.min - 8 && waterTemp <= fish.max + 8) {
      return { text: 'Zayıf', class: 'poor' };
    } else {
      return { text: 'Kritik', class: 'critical' };
    }
  }
  
  function updateFishComfort(waterTemp) {
    const selectedSpecies = fishSpecies.value;
    const status = getFishStatus(waterTemp, selectedSpecies);
    
    // Update temperature display
    fishWaterTemp.textContent = waterTemp.toFixed(1);
    
    // Update status text and icon
    fishStatus.textContent = status.text;
    fishStatus.className = 'status-text ' + status.class;
    fishStatusIcon.className = 'status-icon ' + status.class;
  }
  
  function changeFishSpecies() {
    // Re-evaluate comfort when species changes
    const currentWaterTemp = parseFloat(fishWaterTemp.textContent) || 18;
    updateFishComfort(currentWaterTemp);
  }
  
  // Smart recommendations system
  function updateRecommendations(weatherTemp, waterTemp, weatherHum, soilMoist, waterLevel, fanState, pumpState) {
    let recs = [];
    
    // System status first
    recs.push("🟢 Sistem çalışıyor");
    
    // Current relay states
    recs.push("🌀 Fan: " + (fanState ? "AÇIK" : "KAPALI"));
    recs.push("💧 Pompa: " + (pumpState ? "AÇIK" : "KAPALI"));
    
    // Temperature analysis
    if (weatherTemp >= 20 && weatherTemp <= 30) {
      recs.push("🌡️ Hava sıcaklığı normal (" + weatherTemp.toFixed(1) + "°C)");
    } else if (weatherTemp > 35) {
      recs.push("🔥 Hava sıcaklığı yüksek! Sulama sıklığını artırın");
    } else if (weatherTemp < 10) {
      recs.push("❄️ Hava sıcaklığı düşük! Bitkileri soğuktan koruyun");
    } else {
      recs.push("🌡️ Hava sıcaklığı: " + weatherTemp.toFixed(1) + "°C");
    }
    
    // Water temperature analysis
    if (waterTemp >= 15 && waterTemp <= 25) {
      recs.push("💧 Su sıcaklığı normal (" + waterTemp.toFixed(1) + "°C)");
    } else if (waterTemp > 30) {
      recs.push("🔥 Su sıcaklığı yüksek! Soğutma gerekli");
    } else if (waterTemp < 10) {
      recs.push("🧊 Su sıcaklığı düşük! Isıtma gerekli");
    } else {
      recs.push("💧 Su sıcaklığı: " + waterTemp.toFixed(1) + "°C");
    }
    
    // Soil moisture analysis - More detailed recommendations
    if (soilMoist < 30) {
      recs.push("🌱 Toprak nemi düşük (" + soilMoist.toFixed(1) + "%)");
      recs.push("💦 Toprak neminin artırılması lazım");
      recs.push("🚿 Sulama başlatılmalı");
    } else if (soilMoist >= 30 && soilMoist < 40) {
      recs.push("🌿 Toprak nemi orta seviyede (" + soilMoist.toFixed(1) + "%)");
      recs.push("💧 Sulama düşünülebilir");
    } else if (soilMoist >= 40 && soilMoist <= 70) {
      recs.push("✅ Toprak nemi optimal (" + soilMoist.toFixed(1) + "%)");
    } else {
      recs.push("🚰 Toprak çok ıslak (" + soilMoist.toFixed(1) + "%)");
      recs.push("⚠️ Drenaj kontrol edilmeli");
      recs.push("🛑 Sulama durdurulmalı");
    }
    
    // Air humidity analysis
    if (weatherHum >= 50 && weatherHum <= 75) {
      recs.push("🌬️ Hava nemi ideal (" + weatherHum.toFixed(1) + "%)");
    } else if (weatherHum < 30) {
      recs.push("🏜️ Hava çok kuru! Nem artırıcı önlemler alın");
    } else if (weatherHum > 85) {
      recs.push("💨 Hava nemi yüksek! Fungal hastalık riski");
    }
    
    // Water level warnings
    if (waterLevel < 1) {
      recs.push("⚠️ Su seviyesi düşük! Rezervuar doldurulmalı");
    } else {
      recs.push("💧 Su seviyesi yeterli");
    }
    
    // Advanced irrigation recommendations
    const needsWater = soilMoist < 35;
    const hotWeather = weatherTemp > 30;
    const lowHumidity = weatherHum < 40;
    
    if (needsWater && hotWeather) {
      recs.push("🔥 Sıcak hava + kuru toprak: Acil sulama gerekli!");
      if (!pumpState) {
        recs.push("⚠️ Pompa kapalı - sulama başlatılmalı!");
      }
    } else if (needsWater && lowHumidity) {
      recs.push("🌵 Kuru hava + kuru toprak: Sulama öncelikli");
      if (!pumpState) {
        recs.push("💡 Pompayı çalıştırmayı düşünün");
      }
    }
    
    // Fan recommendations
    if (hotWeather && !fanState) {
      recs.push("🌡️ Sıcak hava: Fan çalıştırılmalı");
    } else if (weatherHum > 85 && !fanState) {
      recs.push("💨 Yüksek nem: Havalandırma gerekli");
    }
    
    // Water level vs pump state check
    if (waterLevel < 1 && pumpState) {
      recs.push("⚠️ DİKKAT: Su seviyesi düşük ama pompa çalışıyor!");
    }
    
    // Time-based recommendations
    const hour = new Date().getHours();
    if (needsWater && (hour >= 6 && hour <= 9)) {
      recs.push("🌅 Sabah saatleri: Sulama için ideal zaman");
    } else if (needsWater && (hour >= 18 && hour <= 20)) {
      recs.push("🌇 Akşam saatleri: Sulama için uygun zaman");
    } else if (needsWater && (hour >= 12 && hour <= 16)) {
      recs.push("☀️ Öğle saatleri: Sulama kaçınılmalı");
    }
    
    // Overall assessment
    if (weatherTemp >= 20 && weatherTemp <= 30 && soilMoist >= 40 && soilMoist <= 70 && weatherHum >= 50 && weatherHum <= 75) {
      recs.push("🎯 Mükemmel tarım koşulları!");
    }
    
    // Update recommendations display
    recommendations.innerHTML = recs.map(rec => `<div class="rec-item">${rec}</div>`).join('');
  }
  setInterval(() => { clock.textContent = new Date().toLocaleString(); }, 1_000);
  // Chart.js setup
  const CHART_TITLES = [
    'Hava Sıcaklığı (°C)',
    'Su Sıcaklığı (°C)',
    'Hava/Su Sıcaklık Oranı',
    'Hava Nem (%)',
    'Toprak Nem (%)',
    'Hava/Toprak Nem Oranı'
  ];
  const CHART_COLORS = [
    '#f75d59', // Hava Sıcaklığı
    '#4A90E2', // Su Sıcaklığı
    '#9c27b0', // Sıcaklık Oranı
    '#4caf50', // Hava Nem
    '#ffb400', // Toprak Nem
    '#26348B'  // Nem Oranı
  ];
  const CHART_CANVAS = [
    'weatherTempChart',
    'waterTempChart',
    'tempRatioChart',
    'weatherHumChart',
    'soilMoistChart',
    'humRatioChart'
  ];
  // Y-axis min/max for each chart
  const CHART_YRANGE = [
    {min:0,max:50},   // Hava Sıcaklığı
    {min:0,max:50},   // Su Sıcaklığı
    {min:0,max:3},    // Sıcaklık Oranı
    {min:0,max:100},  // Hava Nem
    {min:0,max:100},  // Toprak Nem
    {min:0,max:3}     // Nem Oranı
  ];
  // Dummy data generator (smooth, realistic)
  function smoothDummyArr(min, max, phase=0, freq=0.15, noise=1) {
    return Array(60).fill(0).map((_,i)=> {
      const base = (Math.sin((i+phase)*freq) + 1) / 2; // 0-1
      const val = min + (max-min)*base + (Math.random()-0.5)*noise;
      return Math.max(min, Math.min(max, val));
    });
  }
  // Chart factory with y-axis range and initial dummy data
  const mkChart = (ctx, col, title, yrange, initialData) => new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array(60).fill(''),
      datasets: [{ borderColor: col, borderWidth: 2, pointRadius: 0, data: initialData }]
    },
    options: {
      animation: false,
      plugins: {
        legend: { display: false },
        title: { display: true, text: title, color: '#333', font: { size: 12, weight: '600' } }
      },
      scales: {
        x: { display: false },
        y: { display: true, min: yrange.min, max: yrange.max }
      }
    }
  });
  // Create charts with smooth dummy data
  const charts = [
    mkChart($(CHART_CANVAS[0]).getContext('2d'), CHART_COLORS[0], CHART_TITLES[0], CHART_YRANGE[0], smoothDummyArr(10, 40, 0, 0.12, 0.7)), // Hava Sıcaklığı
    mkChart($(CHART_CANVAS[1]).getContext('2d'), CHART_COLORS[1], CHART_TITLES[1], CHART_YRANGE[1], smoothDummyArr(12, 32, 10, 0.11, 0.6)), // Su Sıcaklığı
    mkChart($(CHART_CANVAS[2]).getContext('2d'), CHART_COLORS[2], CHART_TITLES[2], CHART_YRANGE[2], smoothDummyArr(0.7, 1.5, 20, 0.09, 0.08)), // Sıcaklık Oranı
    mkChart($(CHART_CANVAS[3]).getContext('2d'), CHART_COLORS[3], CHART_TITLES[3], CHART_YRANGE[3], smoothDummyArr(40, 80, 30, 0.13, 2)), // Hava Nem
    mkChart($(CHART_CANVAS[4]).getContext('2d'), CHART_COLORS[4], CHART_TITLES[4], CHART_YRANGE[4], smoothDummyArr(30, 70, 40, 0.14, 2)), // Toprak Nem
    mkChart($(CHART_CANVAS[5]).getContext('2d'), CHART_COLORS[5], CHART_TITLES[5], CHART_YRANGE[5], smoothDummyArr(0.7, 1.3, 50, 0.08, 0.07)), // Nem Oranı
  ];
  const push   = (ch,v)=>{const d=ch.data.datasets[0].data;d.push(v);if(d.length>60)d.shift();ch.update('none');};
  
  // Notifications functionality
  function addNotification(message) {
    console.log('🔔 addNotification called with:', message);
    
    const recommendationsDiv = document.getElementById('recommendations');
    console.log('📋 recommendations div found:', !!recommendationsDiv);
    
    if (!recommendationsDiv) {
      console.error('❌ recommendations div not found!');
      return;
    }
    
    // Create notification item
    const notificationItem = document.createElement('div');
    notificationItem.className = 'rec-item auto-notification';
    notificationItem.style.cssText = `
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 8px 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      border-left: 3px solid #047857;
      box-shadow: 0 2px 4px rgba(16,185,129,0.2);
      animation: slideInRight 0.5s ease-out;
      font-weight: 500;
    `;
    
    // Add timestamp
    const timestamp = new Date().toLocaleTimeString();
    notificationItem.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>${message}</span>
        <small style="opacity: 0.8; font-size: 10px;">${timestamp}</small>
      </div>
    `;
    
    console.log('📝 Created notification element:', notificationItem);
    
    // Add to top of recommendations
    recommendationsDiv.insertBefore(notificationItem, recommendationsDiv.firstChild);
    console.log('✅ Notification added to DOM');
    
    // Remove old notifications to keep only last 5
    const notifications = recommendationsDiv.querySelectorAll('.auto-notification');
    if (notifications.length > 5) {
      for (let i = 5; i < notifications.length; i++) {
        notifications[i].remove();
      }
    }
    
    // Scroll to top to show new notification
    recommendationsDiv.scrollTop = 0;
    
    console.log('🎉 Notification successfully added to recommendations panel:', message);
  }

  // Test function for notifications (can be called from browser console)
  function testNotification() {
    const testMessage = '🧪 Test: Bu bir manuel test bildirimidir!';
    console.log('🔬 Testing notification manually...');
    addNotification(testMessage);
  }

  // Make test function available globally
  window.testNotification = testNotification;

  // Chatbot functionality
  let isTyping = false;
  
  function addMessage(message, isUser = false, isAutoNotification = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${isUser ? 'user' : 'assistant'} ${isAutoNotification ? 'auto-notification' : ''}`;
    
    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'assistant'} ${isAutoNotification ? 'auto-notification' : ''}`;
    bubble.textContent = message;
    
    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = new Date().toLocaleTimeString();
    
    messageDiv.appendChild(bubble);
    messageDiv.appendChild(time);
    chatArea.appendChild(messageDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // Add a subtle animation for auto notifications
    if (isAutoNotification) {
      messageDiv.style.animation = 'slideInLeft 0.5s ease-out';
    }
  }
  
  function showTypingIndicator() {
    if (isTyping) return;
    isTyping = true;
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message assistant';
    typingDiv.id = 'typing-indicator';
    
    const indicator = document.createElement('div');
    indicator.className = 'typing-indicator';
    indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    
    typingDiv.appendChild(indicator);
    chatArea.appendChild(typingDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
  }
  
  function hideTypingIndicator() {
    isTyping = false;
    const indicator = document.getElementById('typing-indicator');
    if (indicator) {
      indicator.remove();
    }
  }
  
  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;
    
    // Add user message
    addMessage(message, true);
    chatInput.value = '';
    
    // Disable input and button
    chatInput.disabled = true;
    sendBtn.disabled = true;
    
    // Show typing indicator
    showTypingIndicator();
    
    try {
      const response = await fetch('/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
      });
      
      const data = await response.json();
      
      if (data.status === 'success') {
        addMessage(data.response);
      } else {
        addMessage('Üzgünüm, bir hata oluştu. Lütfen tekrar deneyin.');
      }
    } catch (error) {
      console.error('Chat error:', error);
      addMessage('Bağlantı hatası. Lütfen tekrar deneyin.');
    } finally {
      hideTypingIndicator();
      chatInput.disabled = false;
      sendBtn.disabled = false;
      chatInput.focus();
    }
  }
  
  function handleChatKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  }
  
  // Function to update device UI toggles and status
  function updateDeviceUI(deviceType, state) {
    let switchElement, statusElement;
    
    if (deviceType === 'fan') {
      switchElement = document.getElementById('fanSwitch');
      statusElement = document.getElementById('fanStatus');
    } else if (deviceType === 'pump') {
      switchElement = document.getElementById('pumpSwitch');
      statusElement = document.getElementById('pumpStatus');
    }
    
    if (switchElement && statusElement) {
      const isOn = state === 1;
      
      // Update toggle switch position
      switchElement.checked = isOn;
      
      // Update status text and class
      statusElement.textContent = isOn ? 'Açık' : 'Kapalı';
      statusElement.className = `device-status ${isOn ? 'on' : 'off'}`;
      
      console.log(`Updated ${deviceType} UI: ${isOn ? 'ON' : 'OFF'}`);
    }
  }
  
  // Make functions globally available
  window.sendMessage = sendMessage;
  window.handleChatKeyPress = handleChatKeyPress;
  window.updateDeviceUI = updateDeviceUI;
  let pktid = 0
  function togglePump(switchElement){
    pktid++
    
    const isOn = switchElement.checked;
    const command = isOn ? 'pump on' : 'pump off';
    const displayAction = isOn ? 'AÇ' : 'KAPAT';
    const statusElement = document.getElementById('pumpStatus');
    
    // Update status indicator
    statusElement.textContent = isOn ? 'Açık' : 'Kapalı';
    statusElement.className = `device-status ${isOn ? 'on' : 'off'}`;
    
    // Send command via WebSocket
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.send(command);
      console.log('Sent pump command:', command);
    } else {
      console.log('WebSocket not connected. Cannot send pump command.');
      // Revert switch position and status if command failed
      switchElement.checked = !isOn;
      statusElement.textContent = !isOn ? 'Açık' : 'Kapalı';
      statusElement.className = `device-status ${!isOn ? 'on' : 'off'}`;
      return;
    }
    
    // Add to command history
    const li = document.createElement('li');
    li.textContent = `⏳ ${new Date().toLocaleTimeString()} - Su Pompası: ${displayAction}`;
    cmdHist.prepend(li);
    if (cmdHist.children.length > 50) cmdHist.lastChild.remove();
    
    console.log(`Pump switched: ${displayAction}`);
    setTimeout(() => ack(li), 1000 + Math.random() * 2000);  // fake ACK
  }

  function toggleFan(switchElement){
    pktid++
    
    const isOn = switchElement.checked;
    const command = isOn ? 'fan on' : 'fan off';
    const displayAction = isOn ? 'AÇ' : 'KAPAT';
    const statusElement = document.getElementById('fanStatus');
    
    // Update status indicator
    statusElement.textContent = isOn ? 'Açık' : 'Kapalı';
    statusElement.className = `device-status ${isOn ? 'on' : 'off'}`;
    
    // Send command via WebSocket
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.send(command);
      console.log('Sent fan command:', command);
    } else {
      console.log('WebSocket not connected. Cannot send fan command.');
      // Revert switch position and status if command failed
      switchElement.checked = !isOn;
      statusElement.textContent = !isOn ? 'Açık' : 'Kapalı';
      statusElement.className = `device-status ${!isOn ? 'on' : 'off'}`;
      return;
    }
    
    // Add to command history
    const li = document.createElement('li');
    li.textContent = `⏳ ${new Date().toLocaleTimeString()} - Fan: ${displayAction}`;
    cmdHist.prepend(li);
    if (cmdHist.children.length > 50) cmdHist.lastChild.remove();
    
    console.log(`Fan switched: ${displayAction}`);
    setTimeout(() => ack(li), 1000 + Math.random() * 2000);  // fake ACK
  }
  function ack(li){
    const ok=Math.random()>0.1;
    li.textContent=li.textContent.replace('⏳',ok?'✅':'❌');
    li.style.color=ok?'var(--green)':'var(--red)';
    console.log(ok?'Command acknowledged':'Command failed');
  }
  window.abortAll = () => {
    [...cmdHist.children].forEach(li=>{
      li.textContent='🔄 '+li.textContent.slice(2);
      li.style.color='#0275D8';
    });
    console.log('ABORT ALL COMMANDS requested');
  };
  let recording=false;
function saveTextFile(filename, text) {
  const blob = new Blob([text], { type: 'text/plain' });        // or "text/csv", "application/json", …
  const url  = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();

  URL.revokeObjectURL(url);
}
  window.recToggle=()=>{
    recording=!recording;
    if (!recording) {
      saveTextFile(`data_log${new Date().toLocaleTimeString()}.txt`, file_text)
      file_text = ''
    }
    recBtn.textContent=recording?'Stop Recording':'Start Recording';
    recBtn.style.background=recording?'#f44336':'';
    console.log(recording?'Recording started':'Recording stopped');
  };
  const scene   = new THREE.Scene();
  const camera  = new THREE.PerspectiveCamera(45, oriCanvas.clientWidth/oriCanvas.clientHeight, 0.1, 100);
  camera.position.set(0,0,4);
  const renderer= new THREE.WebGLRenderer({alpha:true,antialias:true});
  renderer.setSize(oriCanvas.clientWidth, oriCanvas.clientHeight);
  oriCanvas.appendChild(renderer.domElement);
  const cube    = new THREE.Mesh(
                    new THREE.BoxGeometry(1,1,1),
                    new THREE.MeshNormalMaterial({wireframe:false}));
  cube.rotation.order='ZYX';
  scene.add(cube);
  const onResize=()=>{
    const w=oriCanvas.clientWidth, h=oriCanvas.clientHeight;
    camera.aspect=w/h; camera.updateProjectionMatrix();
    renderer.setSize(w,h);
  };
  window.addEventListener('resize', onResize);
  const renderLoop=()=>{renderer.render(scene,camera);requestAnimationFrame(renderLoop);};
  renderLoop();
  let tick=0,maxAlt=0,maxVel=0,maxDes=0,startMission,startPhase,totalPkt=0,lostPkt=0;
  const fmtTime=ms=>{const s=ms/1e3|0,h=s/3600|0,m=(s%3600)/60|0,sec=s%60;return[h,m,sec].map(v=>String(v).padStart(2,'0')).join(':');};
  const rnd=(a,b)=>Math.random()*(b-a)+a;
  
  // Global consistent dummy data state
  let dummyState = {
    weatherTemp: 25,
    waterTemp: 18,
    weatherHum: 60,
    soilMoist: 45,
    waterLevel: 1,
    time: 0
  };
  
  // Update dummy data with smooth, realistic changes
  function updateDummyData() {
    dummyState.time += 0.1;
    const t = dummyState.time;
    
    // Smooth variations using sine waves + small random noise
    dummyState.weatherTemp = 25 + 8 * Math.sin(t * 0.05) + (Math.random() - 0.5) * 2;
    dummyState.waterTemp = 18 + 6 * Math.sin(t * 0.04 + 1) + (Math.random() - 0.5) * 1.5;
    dummyState.weatherHum = 60 + 20 * Math.sin(t * 0.03 + 2) + (Math.random() - 0.5) * 3;
    dummyState.soilMoist = 45 + 15 * Math.sin(t * 0.035 + 3) + (Math.random() - 0.5) * 2;
    dummyState.waterLevel = Math.random() > 0.9 ? 0 : 1; // Occasionally low
    
    // Keep values in realistic ranges
    dummyState.weatherTemp = Math.max(15, Math.min(40, dummyState.weatherTemp));
    dummyState.waterTemp = Math.max(10, Math.min(30, dummyState.waterTemp));
    dummyState.weatherHum = Math.max(30, Math.min(90, dummyState.weatherHum));
    dummyState.soilMoist = Math.max(20, Math.min(80, dummyState.soilMoist));
  }
  
  last = Date.now()
  f = true
  function telemetry(){
    updateData(); // Update our static data with logical formulas
    console.log("Updated data:", data);
    
    // Get all sensor values first
    const weatherTemp = data.weatherTemp;
    const waterTemp = data.waterTemp;
    const weatherHum = data.weatherHum;
    const soilMoist = data.soilMoist;
    
    const fault=tick%10===0;
    const alt = data.altitude;
    const vel = data.velocity;
    const bat = data.battery_voltage;
    const temp = data.temperature;
    const hum = data.humidity;
    const pres = data.pressure;
    const light = data.light;
    const roll=rnd(-45,45), pitch=rnd(-45,45), yaw=rnd(-180,180);
    landed = false
    if (Math.abs(vel) <= 1) {
      if (f && Date.now() - last >= 5) landed = true
      else if (!f) f = true, last = Date.now();
    } else landed = f = false, last = Date.now();
    tick++;
    // Update metric boxes first
    document.getElementById('weatherTemp').textContent = weatherTemp.toFixed(1) + ' °C';
    document.getElementById('waterTemp').textContent = waterTemp.toFixed(1) + ' °C';
    document.getElementById('weatherHum').textContent = weatherHum.toFixed(1) + ' %';
    document.getElementById('soilMoist').textContent = soilMoist.toFixed(1) + ' %';
    
    // These elements don't exist in the current HTML, skip them
    if(!startMission) startMission=startPhase=Date.now();
    // Skip system status updates - panel now only shows recommendations
    
    // Calculate actual ratios
    const tempRatio = waterTemp !== 0 ? (weatherTemp / waterTemp) : 1;
    const humRatio = soilMoist !== 0 ? (weatherHum / soilMoist) : 1;
    
    // Update charts with consistent data
    push(charts[0], weatherTemp);
    push(charts[1], waterTemp);
    push(charts[2], tempRatio);
    push(charts[3], weatherHum);
    push(charts[4], soilMoist);
    push(charts[5], humRatio);
    
    // Update fish comfort index
    updateFishComfort(waterTemp);
    const rot = updateIMU(
      data.acc[0], data.acc[1], data.acc[2],
      data.gyro[0], data.gyro[1], data.gyro[2]
    )
    cube.rotation.set(
      THREE.MathUtils.degToRad(rot.pitchDeg),
      THREE.MathUtils.degToRad(rot.yawDeg),
      THREE.MathUtils.degToRad(rot.rollDeg)
    );
    if(tick%5===0)console.log(`TEMP:${weatherTemp.toFixed(1)}°C HUM:${weatherHum.toFixed(1)}% WATER:${waterTemp.toFixed(1)}°C SOIL:${soilMoist.toFixed(1)}%`);
    
    // Water level from static data
    const waterLevel = data.waterLevel;
    const waterFill = document.getElementById('waterFill');
    const waterLevelText = document.getElementById('waterLevelText');
    if (waterLevel >= 1) {
      waterFill.style.height = '90%';
      waterLevelText.textContent = 'Normal';
      waterFill.style.background = 'linear-gradient(to top,#4A90E2 80%,#b3d8fd)';
    } else {
      waterFill.style.height = '25%';
      waterLevelText.textContent = 'Düşük';
      waterFill.style.background = 'linear-gradient(to top,#f75d59 80%,#ffd6d6)';
    }
    
    // Update smart recommendations
    updateRecommendations(weatherTemp, waterTemp, weatherHum, soilMoist, waterLevel, data.fanState, data.pumpState);
    
    // Environmental metrics already updated at top of function
  }
  window.togglePump = togglePump;
  window.toggleFan = toggleFan;
  window.changeFishSpecies = changeFishSpecies;
  console.log('AgriTesk Sistemi başlatıldı');
  
  // Add welcome message to chatbot
  setTimeout(() => {
    addMessage('Merhaba! Ben AgriTesk tarım uzmanı asistanınızım. 🌱 Sensör verilerini analiz ederek size tarımsal öneriler sunuyorum. Sorularınızı bekliyorum!');
  }, 1000);
  
  // Connect to WebSocket
  connectWebSocket();
  
  // Start with static data immediately
  updateData();
  telemetry(); // Run once immediately
  setInterval(telemetry,1_000);
})();
</script>
</body>
</html>